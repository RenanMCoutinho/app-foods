<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Entregas - Relatório</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f8f9fa;
    }
    .card {
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand navbar-dark bg-success mb-4">
    <div class="container">
      <a class="navbar-brand" href="index.html">Home</a>
      <a class="navbar-brand" href="cadastro.html">Cadastro</a>
      <a class="navbar-brand" href="relatorio.html">Relatório</a>
    </div>
  </nav>

  <main class="container">
    <div class="card p-4 mb-4">
      <h1 class="mb-4 text-center text-success">Relatório de Entregas</h1>

      <div class="row mb-3">
        <div class="col-md-5 mb-3 mb-md-0">
          <label for="dataInicio" class="form-label">Data Início</label>
          <input type="date" id="dataInicio" class="form-control" />
        </div>
        <div class="col-md-5">
          <label for="dataFim" class="form-label">Data Fim</label>
          <input type="date" id="dataFim" class="form-control" />
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button id="btnFiltrar" class="btn btn-primary w-100">Filtrar</button>
        </div>
      </div>

      <div id="relatorioDias"></div>

      <div class="text-end">
        <strong>Total Geral:</strong> R$ <span id="totalRelatorio">0.00</span>
      </div>

      <button id="btnGerarPdf" class="btn btn-success mt-3 w-100">Gerar PDF</button>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const relatorioDias = document.getElementById("relatorioDias");
    const totalRelatorio = document.getElementById("totalRelatorio");
    const btnFiltrar = document.getElementById("btnFiltrar");
    const btnGerarPdf = document.getElementById("btnGerarPdf");

    function formatarData(d) {
      const dt = d.toDate ? d.toDate() : new Date(d);
      const day = String(dt.getDate()).padStart(2, "0");
      const month = String(dt.getMonth() + 1).padStart(2, "0");
      const year = dt.getFullYear();
      return `${day}/${month}/${year}`;
    }

    async function buscarEntregasPorPeriodo(dataInicio, dataFim) {
      if (!window.db) {
        alert("Firebase não inicializado!");
        return [];
      }

      const inicio = new Date(dataInicio);
      const fim = new Date(dataFim);
      fim.setHours(23, 59, 59, 999);

      const snapshot = await window.db
        .collection("entregas")
        .where("timestamp", ">=", firebase.firestore.Timestamp.fromDate(inicio))
        .where("timestamp", "<=", firebase.firestore.Timestamp.fromDate(fim))
        .get();

      return snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
    }

    function mostrarEntregasAgrupadas(entregas) {
      relatorioDias.innerHTML = "";
      const diasMap = {};
      let totalGeral = 0;

      entregas.forEach((e) => {
        if (!diasMap[e.data]) diasMap[e.data] = [];
        diasMap[e.data].push(e);
        totalGeral += e.valorFrete;
      });

      Object.keys(diasMap)
        .sort((a, b) => {
          // Ordena pelo formato dd/mm/yyyy
          const [d1, m1, y1] = a.split("/").map(Number);
          const [d2, m2, y2] = b.split("/").map(Number);
          return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
        })
        .forEach((dia) => {
          const ul = document.createElement("ul");
          ul.className = "list-group mb-3";

          const titulo = document.createElement("h5");
          titulo.textContent = `Dia ${dia}`;
          titulo.className = "text-primary mt-3";
          relatorioDias.appendChild(titulo);

          let totalDia = 0;
          diasMap[dia].forEach((e) => {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.textContent = `${e.nomeEmpresa} (${e.tipoEntrega || "N/A"}): R$ ${e.valorFrete.toFixed(2)}`;
            ul.appendChild(li);
            totalDia += e.valorFrete;
          });

          const liTotal = document.createElement("li");
          liTotal.className = "list-group-item active d-flex justify-content-between";
          liTotal.innerHTML = `<strong>Total do dia:</strong> <span>R$ ${totalDia.toFixed(2)}</span>`;
          ul.appendChild(liTotal);

          relatorioDias.appendChild(ul);
        });

      totalRelatorio.textContent = totalGeral.toFixed(2);
    }

    btnFiltrar.addEventListener("click", async () => {
      const dataInicio = document.getElementById("dataInicio").value;
      const dataFim = document.getElementById("dataFim").value;

      if (!dataInicio || !dataFim) {
        alert("Informe as duas datas para filtrar.");
        return;
      }
      if (dataFim < dataInicio) {
        alert("Data fim deve ser maior ou igual à data início.");
        return;
      }

      const entregas = await buscarEntregasPorPeriodo(dataInicio, dataFim);
      mostrarEntregasAgrupadas(entregas);
    });

    btnGerarPdf.addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("Relatório de Entregas", 14, 22);

      let y = 30;
      const dias = relatorioDias.querySelectorAll("h5, ul li");

      if (dias.length === 0) {
        alert("Nenhum dado para gerar relatório.");
        return;
      }

      dias.forEach((el) => {
        if (el.tagName === "H5") {
          doc.setFontSize(14);
          doc.text(el.textContent, 14, y);
        } else {
          doc.setFontSize(11);
          doc.text(el.textContent, 16, y);
        }
        y += 8;
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
      });

      doc.setFontSize(14);
      doc.text(`Total Geral: R$ ${totalRelatorio.textContent}`, 14, y + 10);

      doc.save("relatorio_entregas.pdf");
    });
  </script>
</body>
</html>
