<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Entregas - Cadastro de Empresas</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand bg-dark navbar-dark mb-4">
    <div class="container">
      <a class="navbar-brand" href="index.html">Home</a>
      <a class="navbar-brand" href="cadastro.html">Cadastro</a>
    </div>
  </nav>

  <div class="container">
    <h1 class="mb-4 text-center">Cadastrar Empresa</h1>

    <form id="formCadastro">
      <input type="hidden" id="empresaId" /> <!-- Para editar -->

      <div class="mb-3">
        <label for="nomeEmpresa" class="form-label">Nome da Empresa</label>
        <input type="text" id="nomeEmpresa" class="form-control" required />
      </div>

      <div class="mb-3">
        <label for="enderecoEmpresa" class="form-label">Endereço</label>
        <input type="text" id="enderecoEmpresa" class="form-control" required />
      </div>

      <div class="mb-3">
        <label for="valorFrete" class="form-label">Valor do Frete (R$)</label>
        <input
          type="number"
          id="valorFrete"
          class="form-control"
          step="0.01"
          min="0"
          required
        />
      </div>

      <button type="submit" class="btn btn-primary w-100 mb-4" id="btnSalvar">Cadastrar</button>
      <button type="button" class="btn btn-secondary w-100 mb-4 d-none" id="btnCancelar">Cancelar edição</button>
    </form>

    <h2>Empresas Cadastradas</h2>
    <table class="table table-striped" id="tabelaEmpresas">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Endereço</th>
          <th>Valor Frete (R$)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const formCadastro = document.getElementById("formCadastro");
      const empresaIdInput = document.getElementById("empresaId");
      const nomeEmpresa = document.getElementById("nomeEmpresa");
      const enderecoEmpresa = document.getElementById("enderecoEmpresa");
      const valorFrete = document.getElementById("valorFrete");
      const btnSalvar = document.getElementById("btnSalvar");
      const btnCancelar = document.getElementById("btnCancelar");
      const tabelaBody = document.querySelector("#tabelaEmpresas tbody");

      if (!window.db) {
        alert("Erro: Firebase não inicializado corretamente!");
        return;
      }

      // Função para carregar empresas e atualizar tabela
      function carregarEmpresas() {
        window.db.collection("empresas").onSnapshot((snapshot) => {
          tabelaBody.innerHTML = "";
          snapshot.forEach((doc) => {
            const data = doc.data();
            const tr = document.createElement("tr");

            tr.innerHTML = `
              <td>${data.nome}</td>
              <td>${data.endereco}</td>
              <td>R$ ${data.valorFrete.toFixed(2)}</td>
              <td>
                <button class="btn btn-sm btn-warning btn-editar" data-id="${doc.id}">Editar</button>
                <button class="btn btn-sm btn-danger btn-excluir" data-id="${doc.id}">Excluir</button>
              </td>
            `;

            tabelaBody.appendChild(tr);
          });

          // Adicionar eventos para os botões Editar e Excluir
          document.querySelectorAll(".btn-editar").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-id");
              try {
                const doc = await window.db.collection("empresas").doc(id).get();
                if (doc.exists) {
                  const empresa = doc.data();
                  empresaIdInput.value = id;
                  nomeEmpresa.value = empresa.nome;
                  enderecoEmpresa.value = empresa.endereco;
                  valorFrete.value = empresa.valorFrete;

                  btnSalvar.textContent = "Salvar Alterações";
                  btnCancelar.classList.remove("d-none");
                  window.scrollTo({ top: 0, behavior: "smooth" });
                }
              } catch (error) {
                alert("Erro ao carregar empresa: " + error.message);
              }
            });
          });

          document.querySelectorAll(".btn-excluir").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-id");
              if (confirm("Tem certeza que deseja excluir esta empresa?")) {
                try {
                  await window.db.collection("empresas").doc(id).delete();
                  alert("Empresa excluída com sucesso!");
                } catch (error) {
                  alert("Erro ao excluir empresa: " + error.message);
                }
              }
            });
          });
        });
      }

      // Enviar formulário para criar ou editar empresa
      formCadastro.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nome = nomeEmpresa.value.trim();
        const endereco = enderecoEmpresa.value.trim();
        const valor = parseFloat(valorFrete.value);

        if (!nome || !endereco || isNaN(valor) || valor < 0) {
          alert("Preencha todos os campos corretamente.");
          return;
        }

        const idEdit = empresaIdInput.value;

        try {
          if (idEdit) {
            // Atualizar empresa existente
            await window.db.collection("empresas").doc(idEdit).update({
              nome,
              endereco,
              valorFrete: valor,
            });
            alert("Empresa atualizada com sucesso!");
          } else {
            // Criar nova empresa
            await window.db.collection("empresas").add({
              nome,
              endereco,
              valorFrete: valor,
            });
            alert("Empresa cadastrada com sucesso!");
          }

          formCadastro.reset();
          empresaIdInput.value = "";
          btnSalvar.textContent = "Cadastrar";
          btnCancelar.classList.add("d-none");
        } catch (error) {
          alert("Erro ao salvar empresa: " + error.message);
        }
      });

      // Cancelar edição
      btnCancelar.addEventListener("click", () => {
        formCadastro.reset();
        empresaIdInput.value = "";
        btnSalvar.textContent = "Cadastrar";
        btnCancelar.classList.add("d-none");
      });

      carregarEmpresas();
    });
  </script>
</body>
</html>
